<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />

    <title>
      311 calls by incident type - pie charts
    </title>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.25/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.25/"></script>

    <script type="text/javascript">
      require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/widgets/Legend",
        "esri/widgets/Expand",
        "esri/widgets/Home",
        "esri/smartMapping/labels/clusters",
        "esri/smartMapping/renderers/pieChart"
      ], function (
        WebMap,
        MapView,
        Legend,
        Expand,
        Home,
        clusterLabelCreator,
        pieChartRendererCreator
      ) {
        (async () => {
          const map = new WebMap({
            portalItem: {
              id: "433b5f7f524a4d1ebf3a9f8e1bd49ee0"
            }
          });

          const view = new MapView({
            container: "viewDiv",
            map,
            constraints: {
              snapToZoom: false
            }
          });

          await view.when();
          const layer = view.map.layers.getItemAt(0);
          layer.effect = "drop-shadow(2px, 2px, 2px, gray)";

          layer
            .when()
            .then(generateClusterConfig)
            .then((featureReduction) => {
              layer.featureReduction = featureReduction;
            })
            .catch((error) => {
              console.error(error);
            });

          async function generateClusterConfig(layer) {
            // generates default labelingInfo
            const { labelingInfo, clusterMinSize } = await clusterLabelCreator
              .getLabelSchemes({ layer, view })
              .then((labelSchemes) => labelSchemes.primaryScheme);

            const { renderer, fields } =
              await pieChartRendererCreator.createRendererForClustering({
                layer,
                shape: "pie"
              });

            const fieldInfos = fields.map((field) => {
              return {
                fieldName: field.name,
                label: field.alias,
                format: {
                  places: 0,
                  digitSeparator: true
                }
              };
            });

            const popupTemplate = {
              content: [
                {
                  type: "text",
                  text: "This cluster represents <b>{cluster_count}</b> features."
                },
                {
                  type: "fields"
                }
              ],
              fieldInfos
            };

            return {
              type: "cluster",
              popupTemplate,
              labelingInfo,
              clusterMinSize,
              labelsVisible: false,
              fields,
              renderer
            };
          }

          view.ui.add(
            new Home({
              view
            }),
            "top-left"
          );

          view.ui.add(
            new Expand({
              view: view,
              content: new Legend({
                view
              }),
              expandIconClass: "esri-icon-layer-list",
              expanded: true
            }),
            "top-left"
          );
        })();
      });
    </script>
  </head>
  <body>
    <div id="viewDiv"></div>
  </body>
</html>
